# 应用层

## 应用层概述

*应用层对应用程序的通信提供服务.*

**应用层协议应当定义?**

- 应用进程交换的报文类型, 请求还是响应 ?

- 各种报文类型的语法, 如报文中各个字段及其详细描述.
- 字段的含义, 即包含在字段中信息的含义.
- 进程何时、如何发送报文, 以及对报文进行响应的规则.

**应用层的功能?**

- 文件传输、访问和管理
- 电子邮件
- 虚拟终端
- 查询服务和远程作业登录

### 网络应用模型

#### C/S 模型 (客户-服务器模型)

服务器: **提供计算服务**的设备

1. 永久提供服务
2. 永久性访问地址/域名

客户机: **请求计算服务的主机**

1. 与服务器通信, 使用服务器提供的服务
2. 间歇性接入网络
3. 可能使用动态 IP 地址
4. 不与其他客户机直接通信

C/S 模型的常见应用: Web, 文件传输FTP, 远程登录, 电子邮件

#### P2P 模型

1. 不存在永远在线的服务器
2. 每个主机既可以提供服务, 也可以请求服务
3. 任意端系统/节点之间可以直接通讯
4. 节点间歇性接入网络
5. 节点可能改变 IP 地址
6. 可拓展性更好

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-05 下午10.49.36.png" style="zoom:33%;" />

> 在P2P 模型中, 接入节点越多, 响应的效率越高, 同时P2P模型拥有更大的健壮性. 应用: 迅雷的P2P加速服务



## DNS 协议

人们不会记忆 IP 地址, 因此需要域名系统方便人们访问网站.

DNS 协议提供域名 $\rightarrow$ IP 的映射查询机制 (域名解析服务)

**域名**

域名分级, 比如 www.fudan.edu.cn 从右向左依次重要度下降, cn 是一级域名, www 是四级域名.

**域名服务器**

- 跟域名服务器
- 顶级域名服务器
- 权限域名服务器
- 本地域名服务器

当一个主机发出 DNS 查询请求, 这个查询请求报文就发送给本地域名服务器.

***分层次域名服务器***

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-05 下午11.13.54.png" style="zoom:27%;" />

### 域名解析过程

#### 递归查询

如果本地域名服务器没有相应内容, 本地域名服务器就查询根域名服务器;

如果根域名服务器没有缓存, 就查询顶级域名服务器;

递归地, 如果顶级域名服务器没有缓存, 就查询权限域名服务器

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-05 下午11.20.48.png" style="zoom:33%;" />

#### 迭代查询

查询一直由一台主机/服务器发起.

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-05 下午11.22.00.png" style="zoom:33%;" />

- 服务器维护高速缓存
- 不光服务器维护高速缓存, 主机本身也会维护解析缓存

## FTP 协议

- 登录 FTP 地址 1) 用户名 + 密码 2) *匿名登录*

- 使用 <u>**TCP 协议 **</u> 实现可靠传输

FTP 服务器维护多个服务器进程, 包括一个主进程和 n 个从属进程.

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午3.33.59.png" style="zoom:33%;" />

控制连接相当于传送文件之前的准备流程, 传输指令, 在会话过程中始终保持

正式传输数据之前会初始化一个数据连接, 文件传输完就可以关闭

**主动传输**

采用 TCP 20 端口

**被动传输**

被动方式由服务器和客户端自行协商决定 (端口号 > 1024)

## 电子邮件 

*电子邮件系统*

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午3.45.24.png" style="zoom:33%;" />

- 发送客户通过用户代理发送邮件
- 邮件缓存在发送方邮件服务器
- 发送方邮件服务器把邮件缓存发送到接收方邮件服务器
- 接收方通过用户代理读取邮件

> 客户代理就是指客户所用的软件

### SMTP 协议

SMTP 规定了在两个相互通信的 <u>SMTP 进程</u>之间应如何交换信息. 

负责发送邮件的 SMTP 进程就是 SMTP 客户, 负责接收邮件的进程就是 SMTP 服务器.

SMTP 规定了 14 条命令和 21 种应答信息 (三位数字代码+简单文字说明)

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午3.52.20.png" style="zoom:25%;" />

**大致过程**

1. 连接建立

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午3.54.17.png" style="zoom:33%;" />

2. 邮件发送

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午3.56.22.png" style="zoom:33%;" />

3. 邮件释放阶段

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午3.57.05.png" style="zoom:33%;" />

**缺点** 

只支持 ASCII 码.

**解决方法**

MIME 通用因特网邮件扩充, 将非ASCII码数据转换成 ASCII 码文件, 代价是更低的编码效率. 

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午3.59.13.png" style="zoom:33%;" />

### POP3 协议

在 POP3 协议中, 服务端是接收端邮件服务器, 客户端是客户代理.

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午4.02.35.png" style="zoom:33%;" />

## 万维网 & HTTPS

万维网是一个大规模的、联机式的信息储藏所/资料空间, 是一个无数个网络站点和网页的集合.

<u>**URL**</u> 统一资源定位符, 用于唯一标识网络资源.

用户通过点击超链接 比如 [https://www.google.com](https://www.google.com) 获取网络资源, 这些资源通过 HTTP 或者 HTTPS 协议传送给使用者.

万维网以**<u>客户/服务器</u>**方式工作, 用户使用的浏览器就是万维网客户程序, 万维网文档所驻留的主机运行服务器程序.

万维网使用**<u>超文本标记语言 (HTML)</u>**, 使得万维网页面设计者可以很方便地从一个界面的链接转到另一个界面, 并能在自己的屏幕上显示出来.

### HTTP 协议

HTTP 定义了浏览器 (或者其他万维网客户进程) 怎么样向万维网服务器请求万维网文档, 以及服务器怎么样把文档传送给浏览器.

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午4.16.46.png" style="zoom:33%;" />

具体而言:

1. 浏览器解析URL
2. 浏览器向 DNS 请求解析 IP 地址
3. DNS 解析出 IP 地址
4. 浏览器与服务器建立 TCP 连接
5. 浏览器发送取文件命令
6. 服务器响应
7. 释放 TCP 连接
8. 浏览器显示

#### HTTP 特点

- HTTP 协议是无状态的, 但在实际工作中, 一些万维网站点常常希望能够识别用户. 方案就是 <u>cookie</u>, 它方便站点识别用户.
- HTTP 协议采用 TCP 连接作为运输协议, 但 HTTP 协议本身是无连接的.

##### 非持久连接

HTTP 报文和 TCP 确认可以一起发送, 每次资源请求需要**两个**RTT

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午4.24.12.png" style="zoom:35%;" />

##### 持久连接

###### 非流水线

除了第一个请求需要2*RTT时间, 后面的报文请求都只需要1个RTT时间.

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午4.25.43.png" style="zoom:33%;" />

###### 流水线

类似于SR与停等协议之间的区别, 第二个RTT开始可以并行式地发送请求, 因此所有请求用2*RTT 就够了.

#### HTTP 报文结构

HTTP 报文包括请求报文、响应报文. 

HTTP 报文**<u>面向文本</u>**, 因此在报文中的每一个字段都是一些 ASCII 码串.

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午4.30.20.png" style="zoom:33%;" />

某浏览器发送的请求报文

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-06 下午4.30.58.png" style="zoom:33%;" />

**状态码的分类(5🀄️), 实际上有31种状态码**

1. 1xx表示通知, 如请求收到或正在处理
2. 2xx表示成功
3. 3xx表示重定向
4. 4xx表示客户差错, 比如请求中有语法错误
5. 5xx表示服务器差错, 如服务器失效无法完成请求

