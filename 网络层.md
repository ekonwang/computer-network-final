[toc]

# 网络层

## 概述

主要任务是把分组从源端传到目的端，为分组交换网上的不同主机提供通信服务。网络层传输单位是<u>数据报</u>。

### 功能

- 路由选择 （为网络包找路）
- 异构网络互联
- 拥塞控制 

> 拥塞控制与流量控制的区别：
>
> 前者是全局性问题，有两种方式1）开环控制/静态方法 2）闭环控制；
>
> 后者通过调节发送方速度解决。



## 数据交换方式

- 电路交换 
- 报文交换 
- 分组交换 

### 电路交换

***基本过程：***

1. 建立连接
2. 通信
3. 拆除连接

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/网络层-电路交换.png" style="zoom:25%;" />

链路上数据具有突发性的特征。为了提高链路的通信效率，可以使用多路复用的技术如 FDM, TDM, WDM 以及 CDM。

***优点***

1. 通信时延小
2. 有序传输
3. 没有冲突
4. 实时性比较强

***缺点***

1. 建立连接的代价比较高
2. 线路独占，使用效率比较低
3. 灵活性比较差 
4. 没有差错控制能力

> 灵活性差的解释：某个交换设备出问题对电路交换的影响比较大，可能导致数条电路无法正常通信。

### 报文交换

***概述***

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/报文交换.png" style="zoom:25%;" />

***优点***

1. 无需建立连接
2. 储存转发，动态分配线路
3. 线路可靠性比较高
4. 线路利用率比较高
5. 多目标服务 （可以传输到多个目的位置）

***缺点***

1. 有储存转发时延
2. 报文大小不确定，需要网络设备有较大缓存空间

### 分组交换

分组：把数据块分割成小的数据块。

两种实现路径：

1. 数据包方式
2. 虚电路方式

***优点***

- 报文交换具有的所有优点
- 储存管理相较于报文交换更为容易

***缺点***

1. 储存转发时延
2. 额外信息需要传输
3. 乱序到达目的主机时，需要对分组排序重组

#### 数据报

##### 几种传输单元名词辨析

网络层可能将报文段分组以满足链路层 MTU 限制。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午1.28.05.png" style="zoom:25%;" />

**无连接服务** 不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同。 

#### 虚电路

虚电路方式将数据报和电路交换方式结合，以发挥二者优点。

虚电路：一条源主机到目的主机类似于电路的路径（逻辑连接），路径上所有节点都要维持这条虚电路的建立，维持一张虚电路表，每一项记录了一个打开的虚电路的信息。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午1.37.51.png" style="zoom:25%;" />

> 本书描述的虚电路服务略有不同：虚电路号是局部性的而非全局性的，用来唯一地标识某条链路。

### 报文交换 v.s. 分组交换

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/报文交换 v.s. 分组交换.png" style="zoom:25%;" />

> 计算时延：从发送方发送第一个比特到最后一个比特到达接受者的时间。
>
> 通常来说，分组交换在理想条件下有更优的效率。

### 三种交换方式的比较

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午1.14.41.png" style="zoom:27%;" />

- 报文交换和分组交换都采取储存转发。
- 传送数据量大，且传输时间远大于呼叫时，选择电路交换。电路交换传输时延最小。
- 从信道利用率来看，报文交换和分组交换优于电路交换，其中分组交换时延更低。

## IP 数据报

### IP 数据报格式

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午9.27.28.png" style="zoom:25%;" />

协议字段举例：

- TCP : 6
- UDP : 17

#### IP 数据报的分片

> 链路上帧的数据部分有一定限制，比如在以太网下的限制是 1500 字节，这个大小被称作 MTU。

IP分组的标识字段就是为了标识同一数据报的各个分片。

- 标志<u>(三位)</u>只有<u>末两位</u>有意义。

**中间位 DF (Don't Fragment)**

DF = 1，禁止分片

DF = 0，允许分片

**最低位 MF(More Fragment)**

MF = 1，后面还有分片

MF = 0，代表最后分片

- 片偏移量的单位是<u>**8字节**</u> （作业题踩坑）

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/IP数据报分片例题.png" style="zoom:25%;" />

#### IP 头部三个长度的总结

总长度字段：1 Byte

片偏移：8 Byte

首部长度：4 Byte

### NAT协议

网络地址转换（Network Address Translation）

在<u>**专用网**</u>连接到<u>**因特网**</u>的路由器上安装NAT软件，安装了NAT软件的路由器叫做NAT路由器，它至少有一个有效的外部全球IP地址。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-04 下午6.37.28.png" style="zoom:25%;" />

> 如同路由表之于路由器。
>
> NAT的关键部分是一个由NAT路由器维护的转换表。

### CIDR 无分类编址

提出变长的子网长度。

#### CIDR 地址块

消除了传统A，B，C 类地址的划分。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/网络层-CIDR.png" style="zoom:33%;" />

*CIDR记法：IP地址后加上 / ，然后写上网络前缀位数。*

一个例子：$192.199.170.82/27$

#### 构成超网

一种路由聚合的算法。把几个小的子网聚合成一个较大的子网。

本质上是合并前缀域。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/网络层-构成超网.png" style="zoom:25%;" />

*在以上的例子中，R2的两个相邻子网具有共同前缀 $206.1.0.0/16$，因此在路由表中可以合并网络一和网络二对应的表项。*

> 使用CIDR可能导致查找路由表可能得到好几个匹配结果，这时采用的策略是默认最长匹配。前缀越长，地址块越小，路由越具体。
>
> 为了提高匹配效率，一般使用的底层数据结构是Trie树，查询的复杂度是O(1) （考虑到查询串是定长的32位）。

计算每个子网的最大可分配地址个数：$2^b-2$ 

需要排除掉子网号全0和全1的地址。

### ARP 协议

在链路层传输时需要 MAC地址，对 IP 分组封装成链路帧。

一般而言，MAC地址使用 ARP高速缓存 IP 到 MAC 地址的映射，如果没有储存相应的映射，就采用ARP协议广播查询。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/网络层-ARP2.png" style="zoom:35%;" />

**广播 ARP 请求分组/响应分组**

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/网络层-广播ARP.png" style="zoom:35%;" />

- 由于在实际网络的链路上传输数据帧时，最终必须使用 MAC 地址。
- ARP协议：完成主机或者路由器IP地址到MAC地址的映射。解决下一跳走哪的问题。被认为是网络层的协议。

ARP协议的4种典型情况：

1. 主机A发送给本网络上的主机B
2. 主机A发给另外一个网络上的主机B
3. 路由器发给本网络的主机A
4. 路由器发送给另一个网络的主机A

### DHCP 协议

动态主机配置协议 DHCP 是应用层协议，使用客户/服务器方式，客户端与服务端通过广播方式进行交互，基于 <u>**UDP**</u> 传输。

DHCP 采用即插即联网的机制，主机可以从服务器动态获取 IP 地址、子网掩码、默认网关、DNS 服务器名称与 IP地址。

#### 基本工作流程

1. 主机广播 DHCP 发现报文
2. DHCP 服务器广播 DHCP 提供报文 （本质上是一个预分配的过程）
3. 主机广播 DHCP 请求报文

4. DHCP 服务器广播 DHCP 确认报文

### ICMP 协议

支持差错（或异常）报告。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-04 下午8.11.33.png" style="zoom:33%;" />

**ICMP 差错报文/ICMP查询报文**

1. 终点不可达
2. 源点抑制，当路由器或者主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据发送速率放慢。
3. TTL = 0
4. 参数问题
5. 改变路由（重定向）

 **不发送ICMP差错报文** 

1. 对于ICMP报文本身不再递归地发送差错报告报文
2. 对于第一个分片之后的数据报片都不发送 ICMP 差错报告报文
3. 对于具有组播地址的数据报都不发送 ICMP 差错报文
4. 对于特殊地址如 localhost 的数据报不发送 ICMP 差错报告报文

#### ICMP 应用

##### Ping 

测试两个主机之间的连通性，使用ICMP 回送请求和回答报文。

##### Traceroute

跟踪一个分组从源点到终点的路径，使用了ICMP时间超过差错报告报文。

### IPv6 与 IPv4 之间的区别

1. 32bit -> 128bit
2. **移除了校验和字段**，优化了每跳的处理时间
3. **移除了可选字段**，变成拓展首部，灵活，由于路由器通常不检查而提高了路由器的处理效率。
4. 支持即插即用，不需要DHCP协议
5. 首部长度必须是8B的整数倍
6. 只能在主机处分片
7. ICMPv6：附加报文类型“分组过大”
8. 支持资源预分配
9. 取消了协议字段，改成了下一步首部字段
10. 取消了总长度字段，该用有效载荷长度字段
11. 取消了服务类型字段

#### IPv6 基本地址类型

- 单播
- 多播
- 任播

#### IPv6 向 IPv4 过渡的策略

##### 双栈协议

双协议栈技术就是在一台设备上同时启用IPv4 和 IPv6 协议栈，以同时能够与 IPv4网络以及 IPv6 网络通信。如果这台设备是一个路由器，那么这台路由器的不同接口上，分配配置 IPv4 和 IPv6 地址，并很有可能分别连接了 IPv4 网络和 IPv6 网络。

如果设备是一台计算机，那么它同时拥有IPv4 地址和 IPv6 地址，并具备同时处理这两个协议地址的功能。

##### 隧道技术

隧道协议将其他协议的数据帧或包重新封装之后然后通过隧道。以实现在不同网络基础设施间通信。

> 从下面的例子可以看出，IPv6的包通过IPv4网络时会被重新封装成IPv4分组，从IPv4 到 IPv6 协议栈是前向兼容的。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-04 下午9.13.07.png" style="zoom:25%;" />

#### 总结

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-04 下午9.16.37.png" style="zoom:50%;" />



## 路由算法与路由协议

- 静态路由算法
- 动态路由算法

> 静态路由由管理员配置，简便、可靠，在负荷稳定、拓扑变化不大的网络中运行效果很好，广泛用于小型商业网络和高度安全性的军用网络。
>
> 路由更新更慢，不适用于大型网络。



<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午1.48.04.png" style="zoom:25%;" />

### 因特网的分层次路由选择协议

**自治系统 AS**：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定该 AS 内的路由，同时还使用一种 AS 之间的路由协议以确定 AS 之间的路由。

一个AS 内的所有网络都属于一个行政单位管辖，一个自治系统的所有路由器在本自治系统内部都必须联通。

### RIP协议和距离向量算法

RIP 是一种分布式的基于<u>距离向量</u>的路由选择协议，是因特网的协议标准，最大优点是简单。

RIP 协议要求网络中每一个路由器都维护从它自己到其他每一个目的网络的唯一最佳距离记录。

**算法流程**

1. 仅和<u>相邻路由器</u>交换信息。
2. 路由器交换的信息是自己的路由表。
3. 每30秒交换一次路由信息，然后路由器根据新信息更新路由表。若超过180s 没收到邻居路由器的通告，则判定与邻居的连接断开，并更新路由表。

*路由器刚开始工作时，只知道直接连接的网络的距离（即1），接着每一个路由器也只和数目很有限的相邻路由器交换并更新路由信息。*

*经过若干次更新之后，所有路由器最终都会知道到达本自治系统任何一个网络的最短距离和下一条路由器的地址，即“收敛”*。

**具体的路由器更新流程**

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午3.00.55.png" style="zoom:25%;" />

1. 对地址为 X 的相邻路由器发来的 RIP 报文，修改此报文中的所有项目：把下一跳字段中的地址改为 X，并把所有的距离字段+1。
2. 对于修改后的 RIP 报文中每一个表项，进行以下操作：
   1. R1 路由表中若没有 Net3，则把该项目填入 R1 路由表
   2. R1 路由表中若有 Net3，则查看下一跳路由器地址：
      - 若下一跳是 X，则直接更新
      - 否则，只有当原来距离更长才选取该表项并更新。

#### RIP 报文

需要记忆：RIP 是应用层协议，使用传输层的 UDP 协议。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午3.09.19.png" style="zoom:25%;" />

#### RIP 协议问题

RIP 特点：当网络出现故障时，要经过比较长的时间才能将此消息传送给所有的路由器，“慢收敛”/书上称作<u>**无限计数**</u>问题。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午3.12.53.png" style="zoom:25%;" />

**水平分割** 尝试抑制无限计数的方法：如果 A 从 B 学习到距离向量，那么 A 发给 B 的路由表将会过滤掉相关的表项。



<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/网络层-RIP.png" style="zoom:25%;" />

### OSPF协议与链路状态算法

使用洪泛法向自治系统内所有路由器发送信息，即路由器通过输出端口向所有相邻路由器发送消息，而每一个相邻路由器又再次将此信息发往其所有相邻路由器（广播）。

**交换内容**

发送的信息就是本路由器相邻的所有路由器的链路状态，包括时延带宽等信息。

**多久交换**

只有监测到链路状态变化时，AS 内部才发生一次泛洪交换。最后，一个路由器都能获知整个 AS 的全局路由状态/全局拓扑。

**算法的大致工作流程**

1. 通过 HELLO 问候分组，了解邻居节点的网络地址
2. 设置到它的每个邻居的成本度量 <u>**metric**</u>
3. 构造 DD 数据库描述分组，并向邻站发送自己的链路状态数据库中的所有链路状态项目中的摘要信息。如果DD 分组中的摘要自己都有，则邻站不做处理；如果有缺失的或者有更新的，则发送 <u>**LSR（链路状态请求分组）**</u> 。
4. 收到邻站的 LSR 之后，发送 <u>**LSU（链路状态更新分组）**</u>进行更新。
5. 更新完毕之后，邻站返回一个 <u>**LSAck（链路状态确认分组）**</u> 表示确认收到。

> 只要有一个邻居路由器的状态变化，就会导致泛洪更新。
>
> 更新完毕之后，使用 Dijikstra 算法构造自己到其他节点的最短路径。

#### OSPF 区域

为了使 OSPF 适用更大的网络，每个 AS 分成若干区域，每一个区域都有一个 32 位的区域标识符。区域也不能太大，在一个区域的路由器原则上不超过200个路由器。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午2.29.45.png" style="zoom:25%;" />

#### OSPF 分组

1. 类型一
2. 类型二
3. 类型三

可以认为是传输层的报文段，采用 IP 协议传输。 

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/网络层-OSPF 分组.png" style="zoom:25%;" />

#### 评 OSPF

- 每隔30min，要刷新一次数据库中的链路状态。
- 由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此<u>网络规模很大时，OSPF表现比距离向量路由RIP好得多。</u> 目前中国骨干网 [chinanet](https://www.ctamericas.com/products-services/internet/chinanet-access/) 采用的 IS-IS 协议和 OSPF 相似。
- OSPF 并不存在坏消息传得慢的问题，它的收敛速度很快。



### 外部网关协议 BGP

BGP 协议交换信息的过程。

BGP 所交换的网络可达性信息就是要到达某个网络所要经过的一系列 AS。当 BGP 发言人相互交换了网络可达性信息之后，各 BGP 发言人就根据所采取的策略从收到的路由信息中找到各 AS 的较好路由。

BGP 发言人交换<u>路径向量</u>的过程：

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午3.25.14.png" style="zoom:25%;" />

#### BGP 协议报文格式

一个 BGP 发言人与其他自治系统的 BGP 发言人要交换路由信息，就要先建立 <u>**TCP**</u> 连接，在此基础上交换 BGP 报文以建立 BGP 会话，利用 BGP 会话交换路由信息。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午3.30.07.png" style="zoom:25%;" />

##### BGP-4 的四种报文

1. OPEN 报文
2. UPDATE 报文
3. KEEPALIVE 报文
4. NOTIFICATION 报文

### 三种路由算法的比较

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-03 下午3.37.22.png" style="zoom:25%;" />

## IP 组播/多播

- 单播
- 广播
- 组播/多播

组播提高了数据的传输效率，发送方只需要发送一个副本，减少了主干网出现拥塞的可能性。组播组中的主机可以是在同一个物理网络，也可以来自不同的物理网络。

IP组播地址让源设备可以将分组发送给一组设备。属于多播组的设备将被分配一个组播组IP地址（一群共同需求主机的相同标识）

组播地址范围为224.0.0.0～239.255.255.255，一个D类地址表示一个组播组。只能用做分组的目的地址。**源地址总是为单播地址。**

![img](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/IP%E7%BB%84%E6%92%AD.png)

### 硬件组播地址

组播MAC地址以16进制值01-00-5e开头，余下的6个十六进制位通过IP组播组地址的最后23位转发得到。

TCP/IP 协议使用的以太网多播地址的范围是：

01-00-5e-00-00-00 到 01-00-5e-7f-ff-ff

![img](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/%E6%88%AA%E5%B1%8F2022-01-04%20%E4%B8%8B%E5%8D%888.47.01.png)

收到多播数据报的主机，还要在IP层利用软件过滤，把不是本主机要接受的数据报丢弃。

### IGMP 协议

让局域网的组播路由器知道子网是否还有可以接受组播数据报的主机。

更详细地，IGMP协议让路由器知道本局域网上是否有主机（的进程）*<u>参加或退出</u>*了某个组播组。

IGMP使用IP协议栈传输报文。

1. 某主机要加入组播组时，该主机向组播组的组播地址发送一个 IGMP 报文，声明自己要称为该组的成员。本地组播组路由器收到 IGMP 报文后，要利用组播路由选择协议把这组成员关系发送给因特网上的其他组播路由器。
2. 本地组播路由器周期性地探询局域网上的主机，以便知道这些主机是否还是组播组的成员。只要有一个主机对某个组相应，那么组播路由器就认为这个组是活跃的；<u>如果经过几次探询之后没有一个主机响应</u>，组播路由器就认为本网络没有此组播组的主机，因此就不再把这组的成员关系发送给其他组播路由器。

### 组播路由选择协议

用最小代价将组播数据报传输到组播组的成员。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-04 下午9.31.37.png" style="zoom:33%;" />

组播路由选择协议常使用的三种算法

- 基于链路状态的路由选择
- 基于距离-向量的路由选择
- 协议无关的组播（稀疏/密集）

### 总结

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-04 下午9.33.40.png" style="zoom:25%;" />





