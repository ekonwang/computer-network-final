# 数据链路层

[toc]

## 基本概念

**结点：**主机、路由器

**链路：**网络中两个结点之间的<u>物理通道</u>，链路的传输介质主要有双绞线、光纤和微波。分为有线链路、无线链路。

**数据链路：**网络中两个结点之间的<u>逻辑通道</u>，把实现控制数据传输协议的硬件和软件加到链路上就构成数据链路。

**帧：**链路层的协议数据单元，封装网络层数据报。

**主要作用：**负责通过一条链路从一个结点向另一个物理链路直接相连的相邻结点传送数据报。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/data-link-layer-2.png" style="zoom:48%;" />

## 功能概述

数据链路层在物理层提供服务的基础上<u>向网络层提供服务</u>，其最基本的服务是将源自网络层来的数据<u>可靠</u>地传输到相邻节点的目标机网络层。

**主要作用：**加强物理层传输原始比特流的功能，将物理层提供的可能出错的物理连接改造成为<u>逻辑上无差错的数据链路</u>，使之对网络层表现为一条无差错的链路。

1. 为网络层提供服务

   - 无确认无连接服务：适合实时通信，误码率比较低。不用事先建立连接，收到后不返回确认也不处理差错。（通信质量好，有线）
   - 有确认无连接服务：适合无线通信，误码率比较高。收到后发回<u>确认</u>，未收到则重发。（通信质量差，无线）
   - 有确认面向连接服务：事先建立好连接，并需要<u>确认</u>。（有连接一定有确认）

2. 链路管理，即连接的建立、维持、释放（用于面向连接的服务）
3. 组帧
4. 流量控制
5. 差错控制（帧错/位错）

### 组帧

在一段数据的前后部分添加首部和尾部，构成帧。

接受端可以利用首部和尾部来识别开始和结束。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/zhen.png" style="zoom:53%;" />

首部和尾部的重要作用：<u>帧定界</u>（确定帧的界限）

**帧同步：**接收方应当能从接收到的二进制比特流中区分出帧的起始和终止。

**组帧的四种方法：**

1. 字符计数法
2. 字符（节）填充法
3. 零比特填充法
4. 违规编码法

### 透明传输

不管所传数据是什么样的比特组合，都应当能够在链路上传送。（不会因为某些冲突导致没法传送某一比特组合的数据）

当所传数据中的比特组合恰巧与某一控制信息完全一样时，就必须<u>采取适当的措施，使收方不会将这样的数据误认为是某种控制信息</u>。这样才能保证数据链路层的传输是透明的。

### 字符计数法

帧首部使用一个计数字段（第一个字节，八位）来表明帧内字符数

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/字符计数.png)

**计数位错了则都错！**

### 字符填充法

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/字符填充.png)

传送的帧是由文本文件组成时（ASCII码与首尾不会相同），可以实现透明传输。

传送的帧是由非ASCII码的文本文件（二进制代码的程序或图像）组成时，就要<u>采用字符填充方法实现透明传输</u>。

**实现方法：**加入转义字符，对于转义字符后面的那一段不认为是控制信息。（类似:）



![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/转.png)

### 零比特填充法

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/5110.png)

**操作：**

1. 在发送端，扫描整个信息字段，只要连续5个1,就立即填入1个0。
2. 在接收端收到一个帧时，先找到标志字段确定边界，再用硬件对比特流进行扫描，发现连续5个1时，就把后面的0删除。

PS：需要注意是**<u>>=5</u>**个1的时候就要在第5个1的后面加。

*<u>保证了透明传输</u>*

### 违规编码法

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/违规.png)



字节计数法：一错都错

字符填充法：实现复杂，不兼容

目前普遍使用**比特填充**和**违规编码法**

## 差错控制

都是由噪声/外界冲击引起的

### 差错类别

**全局性：**电气特性所产生的随机噪声，提高信噪比来解决（对传感器下手）

**局部性：**外界特定的短暂原因所造成的冲击噪声，是产生差错的主要原因，利用编码技术解决。

### 差错类型

1. 位错：比特位出错，0/1之间转变
2. 帧错：1-2-3
   - 丢失1-3
   - 重复1-2-2-3
   - 失序1-3-2

### 比特错

#### 编码方式

1. 检错编码
   - 奇偶校验码
   - 循环冗余码
2. 纠错编码
   - 海明码

**注意：**物理层的数据编码与调制针对的是<u>*单个比特的同步问题*</u>，而数据链路层的编码是利用冗余码来解决一组比特的差错问题。

#### 奇偶校验码

n+1个bit为n位信息元+1位校验码，最后校验码表示的奇偶是包含校验码本身的”1“的个数的奇偶性。比如当校验码采用偶校验时，校验位$p$ = $a_1 \oplus a_2\oplus\dots\oplus a_n$，相应的监督关系式：$S=p\oplus a_1 \oplus a_2\oplus\dots\oplus a_n$ 为 0 时才代表校验成功。

**特点：**只能检查出<u>*奇数个比特*</u>错误，检错能力为50%

#### CRC循环冗余码

最终发送的数据：要发送的数据+帧检验序列FCS

计算冗余码：

1. **加0：**假设生成多项式G(x)的阶为r，则增加r个0。<u>**也就是$G(x)$ 比 $R(x)$ 要多出1位.**</u>

2. **模2除法：**数据加0后<u>*除以多项式*</u>，<u>*余数*</u>为冗余码/FCS/CRC检验码的比特序列。

二进制串 $\rightarrow$ 多项式域过程：

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2021-12-31 下午10.37.53.png" style="zoom:50%;" />

竖式除法计算过程：

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/%E6%88%AA%E5%B1%8F2021-12-13%20%E4%B8%8B%E5%8D%888.33.44.png" style="zoom:50%;" />

##### 接受端检错过程

​	把收到的每一个帧都除以相同的除数，然后检查得到的余数R。

1. 余数为0，判定这个帧没有差错。 <u>*接受*</u>

2. 余数不为0,判定这个帧有差错（无法确定到位） <u>*丢弃*</u>

​	FCS的生成以及接受端CRC检验都是由<u>*硬件*</u>实现，处理很迅速，因此不会延误数据的传输。

​	只能做到对帧的无差错接收（接近于1的概率）。

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2021-12-31 下午10.37.53.png" style="zoom:50%;" />

### 线性分组码（海明码）

<u>*检测双*</u>比特错，<u>*纠正单*</u>比特错。

对于突发性错误无能为力，可以采用p列的矩阵来解决一部分问题。

实践中可以增加一个<u>*奇偶校验位*</u>进一步判断错误类型。

#### 海明距

相同位数的两个数，若某一位不同，则距离$+1$

为检出$e$个错码，要求码集的海明距离$d≥e+1$。
为纠正$t$个错码，要求码集的海明距离$d≥2t+1$。
为检出$e$个错码，同时能纠正$t$个错码，则应满足   $d≥e+t+1 (e>t)$。

#### 海明不等式

$$
2^r \geq k+r+1\\
r为冗余信息位，k为信息位
$$

#### 工作流程

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/hmm.png)

确定校验码位数r->确定校验码和数据的位置->求出校验码的值->检错并纠错

1. 确定校验码位数：利用下面的海明不等式进行确定。

2. 确定校验码和数据码的位置：假设校验码$a_2,a_1,a_0$，数据码$a_6,...,a_3$，则最后发送为$a_6,...,a_0$。

   利用上述的式子构成监督关系式S2,S1,S0，有几个校验码就有几个监督关系式。

   | $S_2S_1S_0$ | 000  | 001   | 010   | 100   | 011   | 101   | 110   | 111   |
   | ----------- | ---- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
   | 错码位置    | 无错 | $a_0$ | $a_1$ | $a_2$ | $a_3$ | $a_4$ | $a_5$ | $a_6$ |

   具体方式是，000表示无错，校验码$a^i$处在值为$2^i$的位，其余依次补全（顺序换一下也没事）即可。<u>**（关键）**</u>

   按上式可以得到
   $$
   S_2 = a_2 \oplus a_4 \oplus a_5 \oplus a_6\\
   S_1 = a_1 \oplus a_3 \oplus a_5 \oplus a_6\\
   S_0 = a_0 \oplus a_3 \oplus a_4 \oplus a_6
   $$

3. 求出校验码的值：我们要确保S2,S1,S0均为0，由此就可以得到
   $$
   a_2 = a_4 \oplus a_5 \oplus a_6\\
   a_1 = a_3 \oplus a_5 \oplus a_6\\
   a_0 = a_3 \oplus a_4 \oplus a_6
   $$

4. 检错并纠错：当接收到传送的数据后，算出S2,S1,S0的值，在一位错的情况下，查表判断谁是错的。

### 总结

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/差错控制.png)

## 流量控制与可靠传输机制

### 数据链路层的流量控制

<u>*较高的发送速度*</u>和<u>*较低的接受能力*</u>的不匹配，会造成传输错误。

数据链路层的流量控制是点对点（两个相邻的结点）的，而传输层的流量控制是端到端（两个主机之间的）。

<u>*数据链路层*</u>流量控制手段：接收方收不下就不回复确认。

<u>*传输层*</u>流量控制手段：接受端给发送端一个窗口公告

### 流量控制的方法

#### 停止-等待协议

每发送完一个帧就停止发送，等待对方的确认，在收到确认后再发送下一个帧。

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/停等.png)

#### 滑动窗口协议

后退N帧协议，选择重传协议

##### 基础概念

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/滑动.png)

发送窗口与接收窗口的大小在这是固定的

1. 停止-等待协议：发送窗口大小=1，接收窗口大小=1 
2. 后退N帧协议（GBN）：发送窗口大小>1，接收窗口大小=1 
3. 选择重传协议（SR）：发送窗口大小>1，接收窗口大小>1 

**可靠传输：**发送端发啥，接收段收啥

**流量控制：**控制发送速率，使接收方有足够的缓冲空间来接收每一个帧。

滑动窗口解决：

1. 流量控制（收不下就不给确认，想发也发不了）
2. 可靠传输（发送方自动重传）

### 停止-等待协议

**需要的原因：**

1. 除了<u>*比特出差错*</u>，底层信道还会出现丢包问题
2. 为了实现流量控制

**研究停等协议的前提：**

1. 只考虑一方发送数据一方接收数据。
2. 不考虑在哪个层次

#### 无差错情况

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/wcctd.png)

#### 有差错情况

**数据帧丢失或检测到帧出错**

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/ycctd.png)

**ACK丢失**

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/ack.png)

**ACK迟到**

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/acklate.png)

#### 性能分析

简单，但信道利用率太低

#### 信道利用率及信道吞吐率

发送方在一个发送周期内，有效地发送数据所需要的时间占整个发送周期的比率。
$$
信道利用率=(L/C)/T\\
T为发送周期\\
L为T内发送的数据的比特数\\
C为发送方数据传输率\\
信道吞吐率=信道利用率*发送方的发送速率
$$
**PS:**计算时间的时候总时间发送周期$T$是时延+传播时间，需要注意题目条件给的是发送周期还是时延。

#### 总结

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/tdsum.png)

### GBN协议

**流水线技术：**

1. 必须增加序号范围
2. 发送方需要缓存多个分组

#### 滑动窗口

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/gbn_n.png)

##### GBN发送方必须响应的三件事

1. 上层的调用
   上层发送数据时候，发送方检查发送窗口，已满则将数据返回给上层，让其等一会再发送（可以缓存一部分），未满则产生一个帧并将其发送。

2. 收到了一个ACK

  GBN协议中，对n号帧的确认采用<u>*累积确认*</u>的方式，标明接收方已经收到n号帧和它之前的全部帧。

3. 超时事件

   超时后发送方重传<u>*所有*</u>已发送但未被确认的帧。

##### GBN接收方要做的事

1. 如果正确收到n号帧，并且按序，那么接收方为n帧发送一个ACK，并将该帧中的数据部分交付给上层。
2. 其余情况都丢弃帧，并为最近按序接收的帧重新发送ACK。接收方无需缓存任何失序帧，只需要维护下一个按序接收的帧序号。

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/gbn.png)

##### 滑动窗口长度

采用n个bit对帧编号，那么发送窗口的尺寸$W_T$应满足$1\leq W_T \leq 2^n-1$，否则接收方无法区别新旧帧。

#### 重点

1. 累积确认（偶尔捎带确认：确认帧和数据一起发）-> 批量重传
2. 接收方只按顺序接收帧，不按序丢弃
3. 确认序列号最大的、按序到达的帧
4. 发送窗口最大为$2^n-1$，接收窗口最大为1

#### 性能分析

因连续发送数据帧而提高了信道利用率

但在重传时必须把原来已经正确传送的数据帧重传，使传送效率降低。

#### 总结

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/gbn_sum.png)

### SR协议

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/sr_f.png)

上下无关系

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/sr_j.png)

#### SR发送方必须响应的三件事

1. 上层的调用

   跟GBN类似

2. 收到了一个ACK

   如果收到ACK，假如该帧序号在窗口内，则SR发送方将那个被确认的帧标记为已接受。如果该帧序号是窗口的下界，则窗口向前移动到具有最小序号的未确认帧处。如果窗口移动了并且有序号在窗口内的未发送帧，则发送这些帧。

3. 超时事件

   每个帧都有自己的定时器，一个超时事件发生后<u>*只重传一个帧*</u>

#### SR接收方要做的事情

1. 来者不拒（窗口内）

   SR接收方将确认一个正确接收的帧而不管其是否按序。失序的帧将被缓存，并返回一个对应帧的ACK，直到所有帧皆被收到为止，这时才可以将一批帧按序交付给上层，然后向前移动滑动窗口。

   如果收到了窗口序号外（小于窗口下界）的帧，就返回一个ACK。

2. 其余情况

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/sr.png)

#### 滑动窗口长度

发送窗口最好等于接收窗口（大了会溢出，小了没意义）
$$
W_{Tmax} = W_{Rmax}=2^{(n-1)}\\
$$

#### 重点

1. 对数据帧逐一确认，收一个确认一个
2. 只重传出错帧
3. 接收方有缓存

#### 总结

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/sr_sum.png)

### 信道划分介质访问控制

**点对点链路：**两个相邻节点通过一个链路相连，没有第三者。应用于PPP协议，常用于<u>*广域网*</u>。（大）

**广播式链路：**所有主机共享通信介质。应用于早期的总线以太网、无线局域网，常用于<u>*局域网*</u>。（小）

​	典型拓扑结构：总线型（单点故障？）、星型（逻辑总线型）

#### 介质访问控制

1. 静态划分信道

   **信道划分介质访问控制**

   - 频分多路复用FDM
   - 时分多路复用TDM
   - 波分多路复用WDM
   - 码分多路复用CDM

2. 动态分配信道

   - 轮询访问介质访问控制 令牌传递协议
   - **随机访问介质访问控制**
     - ALOHA协议
     - CSMA协议
     - **CSMA/CD协议**
     - **CSMA/CA协议**

#### 信道划分介质访问控制

将使用介质的每个设备与来自同一信道上的其他设备的通信隔离开，把**时域和频域资源**合理地分配给网络上的设备。

**多路复用技术：**把多个信号组合在一条物理信道上进行传输，使得多个计算机或终端设备**共享信道资源**，提高信道利用率。

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/mux.png)

#### 频分多路复用

频分复用的所有用户在同样的时间占用不同的带宽资源。

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/fmux.png)

优点：

1. 充分利用传输介质带宽，系统效率较高
2. 技术比较成熟，实现也比较容易

#### 时分多路复用

每一个时分复用的用户在每一个TDM帧中占用**固定序号的时隙**，所有用户轮流占用信道（时间片）

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/tmux.png)

##### 统计时分复用

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/ttmux.png)

STDM帧的时隙数**小于**连接在集中器上的用户数。用户有了数据就随时发往集中器的**输入缓存**，集中器依据先来先服务（按顺序放入缓存），一个STDM帧满了就直接发走。<u>*STDM不是固定分配时隙，而是按需动态分配时隙。*</u>

#### 波分多路复用

本质是<u>*光的频分多路复用*</u>

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/lmux.png)

#### 码分多路复用CDM

**码分多址（CDMA）**是码分复用的一种方式

1个bit分为多个码片/芯片，每一个站点被指定一个唯一的m位的芯片序列。

发送1时站点发送芯片序列，发送0时发送芯片序列反码（通常把0写成-1）。

**不冲突：**确保各个站点芯片序列相互正交

**合并方式：**各路数据在信道中被线性相加

**分离方式：**合并的数据和源站规格化内积

以课本P117为例

**发送过程：**

1. 首先得到每个节点的码片序列，确保一起发送的一组节点之间两两互相正交，即内积为0。

   同时也得保证发送的码片序列与自己的内积为1

   发送0的时候即发送码片序列的按位取反.

2. 对于码片序列中的0，其双极型表示为-1，1则就是1。

   比如 0 0 0 1 1 0 1 1的双极型表示即为(-1-1-1+1+1-1+1+1)（可以看成一个向量）

3. 假如A想要不发，B想要发1，C想要发0，D想要不发，则序列为-10-，最后发送的内容即为四个节点的双极型表示的和，令其为S（按位相加）。

4. 在收到S之后，假如节点A的码片序列为A，则节点A发送的内容即为$\frac{S \cdot A}{8}$，

   在此过程中，接收方必须要知道发送方的码片序列。记得这里的8是码片序列的长度，实际的码片序列长度比8位要长得多，通常是64/128位。

**可能遇到的问题：**

1. 软容量（正交码并不多，所以实际中采用个数没有硬性规定的准正交码，虽不能准确分割但大多数情况下影响较小）。
2. 远近问题（考虑无线信号，远端用户的信号有更大的多址干扰，性能更差，一般通过功率控制解决。）

**特性：**

1. 软容量
2. 抗噪声和多径干扰能力强（得益于扩频技术），支持小区之间的软切换。3G基础

### 随机访问介质控制

所有用户可随机发送信息。发送信息时占**全部带宽**。

解决不协调导致的冲突问题

#### 纯ALOHA协议

不监听信道，不按时间槽发送，随机重发。<u>*想发就发*</u>

如果发生冲突，接收方就会检测出差错，然后不予确认，发送方在一定时间内收不到就判断发生冲突。

超时后等一随机时间再重传。

> ​	分析思路：吞吐率 = 帧时内平均帧数 * 每帧期望发送成功率	
>
> ​	对于$t_0+t$时间开始的时长为$t$的数据帧，$t_0$开始到$t_0+2t$结束这段时间内发送的数据帧都会与其冲突，由泊松分布$P_r[k]=\frac{G^ke^{-G}}{k!}$可知，生成0帧的概率为$e^{-G}$，故在两个帧时都没有帧生成的概率为$e^{-2G}$，这也是其帧传输成功概率。根据$S(吞吐率)=G(负载)P_0(帧传输成功概率)$可知$S=Ge^{-2G}$，当G=0.5时，吞吐率最大约为0.18。

> ​	分析思路：每个用户的每帧时发送平均成功率 = 每用户每帧时期望发送帧数 * 平均发送成功率。	
>
> ​	对于N位用户的话，可以得到如下公式$\frac{S}{N}=\frac{G}{N}*(1-\frac{G}{N})^{2(N-1)}$（之后回头推一下），极限与上面那个S相同。

#### 时隙ALOHA协议

把时间分成若干个相同的时间片，所有用户在时间片开始时刻同步接入网络信道，若发生冲突，则必须等到下一个时间片开始时刻再发送。

> ​	分析思路：每个时槽平均负载 * 每个帧的期望成功率
>
> ​	$S=Ge^{-G}$，可以用习题的那个推导，主要区别在于普通 ALOHA 本质上要求两个连续时槽没有其他负载，而时隙 ALOHA 要求本时槽没有其他负载就可以。
>
> ​	对于有限用户：$\frac{S}{N}~=~\frac{G}{N}(1-\frac{G}{N})^{N-1}$，求极限之后$S$ 依然为 $S=Ge^{-G}$ 推导关键：$lim_{n\rightarrow \inf}(1+\frac{x}{n})^n~=~e^{x}$ 

##### 二者特点

纯ALOHA协议比时隙ALOHA协议吞吐量更低，效率更低。

纯ALOHA想发就发，时隙ALOHA有控制地发。

#### CSMA协议（载波监听多路访问协议）

**CS：**载波监听，每一个站在发送数据之前要检测一下总线上是否有其他计算机在发送数据。（检测总线上的信号电压摆动值）

**MA：**多点接入，表示许多计算机以多点接入的方式连接在一根总线上。

**协议思想：**发送帧之前，<u>*监听*</u>信道

**监听结果：**

1. 信道空闲：发送完整帧
2. 信道忙：推迟发送
   - 1-坚持CSMA
   - 非坚持CSMA
   - p-坚持CSMA

##### 1-坚持CSMA

坚持指的是对于监听信道忙之后的坚持

如果一个主机要发送消息，那么它先监听信道。<u>*空闲则直接传输*</u>，不必等待；<u>*忙则一直监听*</u>，直到空闲马上传输；如果<u>*有冲突*</u>（一段时间内未收到肯定回复），则<u>*等待一个随机长的时间*</u>再监听，重复上述过程。

优点：只要媒体空闲，站点就马上发送，避免了媒体利用率的损失。

缺点：假如有两个或两个以上的站点有数据要发送，冲突就不可避免。

##### 非坚持CSMA（0-）

非坚持指的是对于监听忙之后就不继续监听。

如果一个主机要发送消息，那么它先监听信道。<u>*空闲则直接传输*</u>，不必等待；<u>*忙则等待一个随机的时间*</u>之后再进行监听；

优点：采用随机的重发延迟时间可以减少冲突发生的可能性。

缺点：可能存在大家都在延迟等待过程中，使得媒体仍处于空闲状态，媒体使用率降低。

##### p-坚持CSMA

p-坚持指的是对于监听信道空闲的处理

如果一个主机要发送消息，那么它先监听信道。<u>*空闲则以概率p立即传输，不必等待*</u>，<u>*以概率1-p延迟一个时槽*</u>后重新监听媒体（并不是发送，而是监听，相当于重复之前的操作）。<u>*忙的话则一直监听到空闲*</u>为止（这个地方貌似好几个地方讲法不一样，以书上为准）。

优点：既能像非坚持算法那样减少冲突，又能像1-坚持算法那样减少媒体空闲时间的这种方案。

缺点：发生冲突后还是要坚持把数据帧发送完，造成了浪费。（<u>CSMA协议不能同时说和听</u>）

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-01 上午10.58.14.png" style="zoom:50%;" />

#### CSMA/CD协议

*“先听再说，边听边说”*

载波监听多点接入 / 碰撞检测协议

**CS：**载波侦听/监听，每一个站在<u>*发送数据之前以及发送数据时*</u>都要检测一下总线上是否有其他计算机在发送数据。（检查是否有信道接入自己站点）

**MA：**多点接入，表示许多计算机以多点接入的方式连接在一根总线上。（总线型网络）

**CD：**碰撞检测（冲突检测），“<u>*边发送边监听*</u>”，适配器边发送数据边检测信道上信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据。（半双工网络）

##### 传播时延对载波监听的影响

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/crash.png)

##### 截断二进制指数规避算法

确定碰撞后的重传时机

1. 确定基本退避（推迟）时间为一个时槽（=在传输媒体上的往返传播时间，以书上为准）
2. 定义参数k，它等于<u>*碰撞次数*</u>，但k不超过10，k=min{碰撞次数，10}。
3. 从离散的整数集合[0,1,...,$2^k-1$]中随机取出一个数r，重传所需要退避的时间就是r倍的基本退避时间，即r个时槽。
4. 当重传达16次仍不能成功时，说明网络太拥挤，认为此帧永远无法正确发出，抛弃此帧并向高层报告出错。

PS：注意第k次重传和第k次发送的区别

##### 最小帧长问题

帧的传输时延至少要两倍于信号在总线中的传播时延 

最小帧长=$2\tau$*数据传输速率

以太网规定最短帧长为64B，凡是长度小于64B都是由于冲突而异常终止的无效帧

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/csmacd_sum.png)

> ##### CSMA/CD 协议性能分析
>
> 某时槽一个节点竞争成功的概率：A = $C_N^1~p~(1-p)^{N-1}~=~Np(1-p)^{N-1}$
>
> 竞争时槽为 $i$ 个的概率 $p_i~=~(1-A)^i~A$
>
> 平均竞争时槽 $\Sigma~p_i~i~=~\frac{1}{A}-1$
>
> 当 $p=\frac{1}{N}$ 时，A 取得最大值，此时 $lim_{N\rightarrow \infin}A=\frac{1}{e}$ 
>
> 平均竞争时槽长度为 $e-1$
>
> 平均信道使用率为 $\frac{1}{1~+~2(e-1)a}$ 其中 $a~=~\frac{T_{prop}}{T_{trans}}$ 

#### CSMA/CA协议

载波监听多点接入/碰撞避免协议

无线局域网

- 无法做到360度全面检测碰撞
- 隐藏节点，暴露节点

而/CD是以太网

##### 工作原理

发送数据前，先检测信道是否空闲

空闲则发出<u>*RTS*</u>，RTS包括发射端的地址、接受端的地址、下一份数据将持续发送的时间等信息；信道忙则等待。

接收端收到RTS后，将响应<u>*CTS*</u>

发送端收到CTS后，开始发送数据帧（同时<u>*预约信道*</u>：发送方告知其他站点自己要传多久数据）。

接受端收到数据帧后；将用CRC来检验数据是否正确，正确则响应<u>*ACK帧*</u>

发送方收到ACK就可以进行下一个数据帧的发送，若没有则一直重传至规定重发次数为止（采用<u>*二进制指数退避算法*</u>来确定随机的推迟时间）

##### 重点

1. 预约信道
2. ACK帧
3. RTS/CTS帧（可选）

#### CSMA/CD与CSMA/CA异同

相同：先听再说

不同：

1. 传输介质不同，CA用于总线式以太网（有线），CA用于无线局域网（无线）
2. 载波检测方式不同，CD检测电缆中电压的变化，CA采用能量检测，载波检测和能量载波混合检测三种检测信道空闲的方式。
3. CD检测冲突，冲突有上限重传16次，CA避免冲突，次数待定。

### 三种比较

#### **信道划分介质访问控制：**

​	基于多路复用技术划分资源

​	<u>*网络负载重：*</u>共享信道效率高且公平

​	*<u>网络负载轻：</u>*共享信道效率低

#### **随机访问MAC协议：**

​	用户根据意愿随机发送消息，发送消息时可独占信道带宽。

​	<u>*网络负载重：*</u>产生冲突开销

​	*<u>网络负载轻：</u>*共享信道效率高，单个结点可利用信道全部带宽

#### **轮询访问MAC协议：**

​	既不产生冲突，又要发送时占全部带宽

### 轮询访问介质访问控制

#### 轮询协议

主结点轮流“邀请”从属结点发送数据，具体而言，主节点会轮流向其他节点发送询问帧。

问题：

1. 轮询开销
2. 等待延迟，靠后节点需要等待
3. 单点故障，如果主节点宕机会导致局域网瘫痪

#### 令牌传递协议

令牌：一个特殊格式的MAC控制帧，不含任何信息。

​			控制信道的使用，确保同一时刻只有一个结点独占信道。

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/lp.png)

问题：

1. 令牌开销
2. 等待延迟
3. 单点故障

应用于令牌环网（物理星型拓扑，逻辑环形拓扑）

采用令牌传送方式的网络常用于<u>*负载较重，通信量较大*</u>的网络中

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-01 下午2.34.08.png" style="zoom:50%;" />

## 局域网概述

局域网：简称LAN，是指在某一区域内由多台计算机互联成的计算机组，使用<u>*广播信道*</u>。

特点：

1. 覆盖的地理范围较小，几km （如复旦的校园网）
2. 使用专门铺设的传输介质（双绞线、同轴电缆）进行联网，数据传输速率高（10Mb/s~10Gb/s）
3. 通信延时短，误码率低，可靠性较高
4. 各站为平等关系，共享传输信道
5. 多采用分布式控制和广播式通信，能进行广播和组播

决定局域网的主要要素为：<u>*网络拓扑*</u>、<u>*传输介质*</u>与<u>*介质访问控制方法*</u>。

#### 局域网拓扑结构

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/tp.png)

#### 局域网传输介质

有限局域网：双绞线、同轴电缆、光纤

无线局域网：电磁波

#### 局域网介质访问控制方法

1. CSMA/CD：常用于总线，也用于树型

2. 令牌总线：常用于总线，也用于树型

   物理总线，逻辑环

3. 令牌环：用于环形局域网，如令牌环网

#### 局域网的分类

1. 以太网：符合IEEE 802.3系列标准规范。逻辑拓扑总线型，物理拓扑是星型或拓展星型。使用CSMA/CD
2. 令牌环网：物理上星型，逻辑上环型，已基本用不上
3. FDDI网：采用了双环拓扑，逻辑上是环型拓扑，用光纤，贵
4. ATM网：较新型的单元交换技术，使用53字节固定长度的单元进行交换。
5. 无线局域网（WLAN）：使用IEEE 802.11标准

#### IEEE 802标准

IEEE 802.3：以太网/Ethernet （有限网）

IEEE 802.5：令牌环网

IEEE 802.8：FDDI

IEEE 802.11：WLAN

#### MAC子层和LLC子层

IEEE 802标准会将数据链路层划分为逻辑链路层LLC子层和介质访问控制MAC子层。

**LLC：**负责识别网络层协议，然后对它们进行封装。LLC报头告诉数据链路层一旦帧被接收到时，应当对数据包做何处理。<u>*为网络层提供服务*</u>：无确认无连接、面向连接、带确认无连接、高速传送

**MAC：**主要功能包括数据帧的封装/卸装，帧的寻址和识别，帧的接收与发送，链路的管理，帧的差错控制等。<u>*MAC子层的存在屏蔽了不同物理链路种类的差异性。*</u>

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/jyw.png)

### 以太网 *

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-11 下午9.40.51.png" style="zoom:50%;" />

基带总线局域网规范，使用CSMA/CD技术，基于总线的局域网标准。

统治性地位：

1. 造价低廉
2. 应用最广泛的局域网技术
3. 比令牌环网、ATM网便宜，简单
4. 满足网络速率要求：10Mb/s~10Gb/s

#### 两个标准

DIX Ethernet V2

IEEE 802.3

二者帧有一点微小的区别，影响不大。

#### 以太网提供无连接、不可靠的服务

无握手，发送方数据不编号，接收方不向发送方确认，差错帧直接丢弃，纠正由高层负责。

<u>*只实现无差错接收，不实现可靠传输*</u>

#### 10BASE-T以太网

传送基带信号的双绞线以太网，T表示采用<u>双绞线</u>，现10BASE-T采用的是无屏蔽双绞线，传输速率是10Mb/s

物理上星型，逻辑上总线型，每段双绞线最长为100m

采用曼彻斯特编码

采用CSMA/CD介质访问控制

#### 适配器与MAC地址

计算机与外界有局域网的连接是通过<u>*通信适配器*</u>的。

适配器上的ROM中有计算机硬件<u>*MAC地址*</u>

硬件地址又称为物理地址或MAC地址

**MAC地址：**每个适配器有一个全球唯一的48位二进制地址，前24位厂家，后24位厂家自己指定。通常由6个十六进制数表示，比如02-60-8c-e4-b1-21

#### SNAP 拓展

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-11 下午9.40.22.png" style="zoom:50%;" />

#### LAN地址与MAC帧

*这是一个普通的以太网帧（DIX协议下）。*

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/v2.png)

目的地址：**单播**、**广播**、**多播**

<img src="https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/截屏2022-01-11 下午9.41.22.png" style="zoom:50%;" />

IEEE地址格式采取低位在前 (little endian)， 前24位用以标识不同厂商。

单播：I/G = 0 目的主机MAC地址。

组播：I/G = 1 代表局域网中的一组站点。

广播：48位地址全1。

U/L = 1 代表本地管理地址，U/L = 0 代表全球唯一的 MAC 地址。 

##### 前导

前面7个字节每个字节为`10101010`，目的是唤醒<u>**接受者**</u>。

最后一个字节取值为`10101011`，最后两个取值为`11`的比特提醒接收方帧的开始。

> 一个问题：以太网下能否同时使用DIX帧与IEEE 802.3帧？
>
> 能。
>
> 采用DIX格式的帧类型字段取值大于`0x0600 =  1536`, 不会与IEEE 802.3 局域网的长度字段混淆（以太网帧长度 <= 1500(MTU) + 18）。
>
> 网卡的驱动程序可以根据该字段的取值范围来确定该帧是那种形式的帧，大多数主机采用的是DIX帧格式。

#### 高速以太网

速率>=100Mb/s的以太网

1. 100BASE-T以太网：双绞线，100Mb/s，基带信号，星型，IEEE 802.3 CSMA/CD，支持全双工和半双工，全双工方式（中心结点变为交换机）下工作无冲突
2. 吉比特以太网：光纤或双绞线，1Gb/s，支持全双工和半双工，全双工下可无冲
3. 10吉比特：光纤，10Gb/s，全双工，无争用问题

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/ytw.png)

#### 全双工以太网

**全双工：**允许两个节点通过支持全双工数据传输的点到点来交换数据，这样节点能够同时传输和接收数据。

**CSMA/CD** 是半双工，一个节点要么传输，要么接受，不能同时做。

**其他方面的比较：**

- 没有别的站点竞争对链路的访问权限，从而不会出现冲突。
- 接收的同时也可以发送，端口支持的吞吐率是**半双工方式的两倍**。
- 站点和交换机之间的连接距离也不再受到**最短帧长的限制**（毕竟不会发生冲突了），而纯粹考虑的是链路的物理特性。
- 采用同样的以太网帧格式、**同样的最小帧长**（历史包袱）、同样的物理层协议。
- 流量控制机制：
  - 半双工：反压机制
  - 全双工：PAUSE帧

**PAUSE帧——流量控制机制**

- 站点可以向链路的另一端发送一个暂停帧而要求停止所有帧的发送。
- **MAC 控制参数为0**的PAUSE帧表示<u>恢复数据帧的传输</u>。
- 有两种流量控制
  - 对称流量控制：全双工链路的两端都可以发送PAUSE帧。
  - 非对称流量控制：只允许其中某一端发送PAUSE帧。
    - 交换机可以发送Pause来阻塞端系统，而反过来则不行（减少注入网络的负载）。
    - 端系统可以阻塞交换机，而反过来则不行（借用交换机的内部缓冲区）。
  - 双方可用自动协商机制决定采用哪种流量控制。

### IEEE 802.11无线局域网

IEEE 802.11a_h，满足b和g属于wifi

#### 802.11的MAC帧头格式

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/mac.png)

#### 四种帧类型

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/4mac.png)

#### 无线局域网的分类

1. 有固定基础设施无线局域网

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/gd.png)

​	wifi名字：服务集标识符

2. 无固定基础设施无线局域网的自组织网络

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/zzz.png)

### 广域网

跨接很大的物理范围，所覆盖的范围从几十公里到几千公里

广域网的通信子网主要使用<u>*分组交换*</u>技术。广域网的通信子网可以利用公用分组交换网、卫星通信网和无线分组交换网，它将分布在不同地区的局域网或计算机系统互连起来，达到<u>*资源共享*</u>的目的。例如因特网

节点交换机：链路层，单个网络转发分组

局域网覆盖物理层、链路层，多点接入，强调传输速度

广域网覆盖物理层、链路层、网络层，点对点，强调资源共享

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/gyw.png)

### PPP协议（点对点）

#### 特点

只支持全双工链路

#### 需要满足的要求

**简单：**对于链路层的帧，无需纠错，无需序号，无需流量控制

**封装成帧：**帧定界符

**透明传输：**与帧定界符一样的比特组合的数据应该如何处理：异步线路用字节填充，同步线路用比特填充

**多种网络层协议：**封装的IP数据报可以采用多种协议

**多种类型链路：**串行/并行，同步/异步，电/光

**差错检测：**错就丢弃

**检测连接状态：**链路是否正常工作

**最大传送单元：**数据部分最大长度MTU

**网络层地址协商：**知道通信双方的网络层地址

**数据压缩协商**

#### 无需满足的要求

**纠错**

**流量控制**

**序号**

**不支持多点线路**

#### 三个组成部分

1. 一个将IP数据报封装到串行链路的方法
2. 链路控制协议LCP：建立并维护数据链路连接 （身份验证）
3. 网络控制协议NCP：PPP可支持多种网络层协议，每个不同的网络层协议都要一个相应的NCP来配置，为网络层协议建立和配置逻辑连接。

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/ppp.png)

> ​	突然发现广域网貌似没教过，那就不看了

### RFID射频识别

#### 基本信息

​	称为电子标签，自动识别技术，非接触式，可工作于各种恶劣环境，通过一个全球唯一的ID标识，标签上储存数据容量更大，可以读取、修改、附加数据，可以对标签数据加密，安全性高。

​	可用于标识识别、物品跟踪、信息采集

#### 架构

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/rfid.png)阅读器包括天线、射频模块和数字信号处理单元

电子标签包括天线和芯片

标签识别码保存在ROM中，用户数据区可以读写、覆盖和添加，容量从几字节（甚至1bit）到几千字节。

#### 分类

1. 基于供电方式
   - 无源电子标签：没有内装电池，射频信号传输通过磁场供电
   - 半无源：内装但仅为电子芯片供电
   - 有源：内装，射频信号传输可通过电池工地那，可以传播较远距离，严格来说不算电子标签
2. 按照是否能够修改
   - 只读
   - 可重写
3. 封装形式
   - 信用卡标签
   - 线形标签
   - ...
4. 频率
   - 低频
   - 高频
   - 超高频
5. 阅读距离远近
   - 0-1cm的密耦合系统、0-1m的遥耦合和超过1m的远距离系统

#### 耦合方式

近距离电感耦合

远距离电磁耦合

#### 数据传输方式

阅读器往电子标签的方向采用广播，通过调制一定频率的载波的参数来传递信息

电子标签往阅读器方向的数据传输依然依赖于阅读器一直发送的射频信号

#### 标签防冲突机制

随机选择时槽[0,$2^Q-1$]来响应，多个时槽没有响应时减少Q值，出现冲突增加Q值。（第4章79页）

## 物理层扩展以太网

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/ct.png)

将多个冲突域通过主干集线器连接，实现冲突域之间的互相传输，但此时冲突域会变大。

> ​	第一组两个互相通信时，第二组两个能不能通信？

### 网桥(书上貌似在网络层？)

根据<u>*MAC帧*</u>的目的地址对帧进行<u>*转发*</u>和<u>*过滤*</u>。当网桥收到一个帧时，并不向所有接口转发此帧，而是先检查此帧的目的MAC地址，然后再确定将该帧转发到哪一个接口，或者是把它丢弃（过滤）

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/wq.png)

#### 网段

一般指一个计算机网络使用同一物理层设备（传输介质、中继器、集线器等）能够直接通讯的那一部分。

#### 优点

1. 过滤通信量，增大吞吐量（AB通信时，CF，EF也能通信）
2. 扩大了物理范围
3. 提高了可靠性，一个网段出差错不会影响其他网段
4. 可互连不同物理层、不同MAC子层和不同速率的以太网

#### 透明网桥

“透明”指以太网上的站点并不知道所发送的帧将经过哪几个网桥，是一种即插即用设备---自学习。本质就是书上的逆向学习法。![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/zfb.png)

#### 源路由网桥

在发送帧时，把详细的最佳路由信息（路由最少/时间最短）放在帧的首部中。**方法：**源站以广播方式向欲通信的目的站发送一个<u>*发现帧*</u>。

#### 网桥生成树算法（重点） :star:

**选取根桥**

选择`BID`最小的网桥

**确定根端口**

每个网桥可了解到根桥方向的路径花费：等于路径上经过的那些连接到另外一个网桥的端口花费之和

- 根路径：网桥到根桥具有最少路径花费的路径
  - 注意：局域网到网桥的边的花费为0
- **根端口**：根路径上第一个跳段所使用的端口
  - 如果有多条最少花费路径时，具有更低端口号的端口为根端口
  - 根桥没有根端口

**确定选取端口**

每个**局域网**上**到根桥**的根路径花费最少(最靠近根桥)的那个**网桥**为**选取桥**。

- 如果有多个可选的网桥时，BID最低的为**选取桥**
- 选取桥连接到该局域网上的端口为**选取端口**
  - 如果有多个端口连接到同一个局域网上，端口号最低的端口为选取端口

> 最后只有根端口和选取端口为转发状态

**更好的`BPDU`消息**

- 收到的BPDU标识一个具有**更小BID的根桥**。
- 收到的BPDU标识**同一个根桥**，但具有**更小的根路径花费**。
- 收到的BPDU的根桥BID和路径花费相同，但**发送**该BPDU的桥**BID更小**。
- 收到的BPDU的根桥BID、路径花费和发送消息的桥BID相同，但**端口号**更小。



### 以太网交换机

独占带宽：与交换机连接的主机或者集线器可以独占交换机的最大带宽。

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/jhj.png)

#### 直通式交换机

查完目的地址（6B）就立刻转发。<u>*延迟小*</u>，可靠性低，无法支持具有不同速率的端口的交换。（可能会考6B）

#### 存储转发式交换机

把帧放入高速缓存，并检查是否正确，正确则转发，错误则丢弃。延迟大，<u>*可靠性高，可以支持具有不同速率的端口的交换*</u>。（常用）

#### 无残帧

和直通类似，以太网交换机在**收到64个字节**的数据后才开始转发

依据：大多数错误和冲突（所有正常的冲突）出现在帧的前面64个字节



### 冲突域和广播域

#### 冲突域

在同一个冲突域中的每一个节点都能收到所有被发送的帧。简单地说就是同一时间内只能有一台设备发送信息的范围。

#### 广播域

网络中能接收任一设备发出的广播帧的所有设备的集合。简单地说如果站点发出一个广播信号，所有能接收收到这个信号的设备范围称为一个广播域。

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/sgy.png)

#### 总结

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/d_sum.png)

## 链路层总结

![](https://cdn.jsdelivr.net/gh/ekonwang/images@master/img/3sum.png)



